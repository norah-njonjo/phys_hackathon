import rebound
import pygame
import numpy as np
import sys
import random
import math
import os

# --- FILE PATH SETUP ---
base_path = os.path.dirname(os.path.abspath(__file__)) if '__file__' in globals() else os.getcwd()

# ==============================
# 1. CLASSES & LOGIC
# ==============================

class Planet:
    def __init__(self, mass, radius, distToSun, name):
        self.mass = mass
        self.radius = radius
        self.distToSun = distToSun
        self.name = name
        self.rebound_particle = None

class SolarSystem:
    def __init__(self, simulation):
        self.sim = simulation
        self.planets = []

    def add_planet(self, planet):
        theta = random.uniform(0, 2 * math.pi)
        self.sim.add(m=planet.mass, a=planet.distToSun, e=0, f=theta)
        planet.rebound_particle = self.sim.particles[-1]
        self.planets.append(planet)

def mass_to_radius(mass):
    return max(3, int((mass ** (1/3)) * 200))

def spawn_batch(player_mass, sun_mass, n=10):
    planets = []
    for i in range(n):
        mass = random.uniform(player_mass * 0.2, player_mass * 2.0)
        mass = min(mass, sun_mass * 0.5)
        dist = random.uniform(0.8, 1.4)
        planet = Planet(mass=mass, radius=mass_to_radius(mass), distToSun=dist, name=f"Planet_{i}")
        planets.append(planet)
    return planets

def custom_merge(sim, collision):
    global screen, win_img_raw, WIDTH, HEIGHT, pygame
    p1 = sim.particles[collision.p1]
    p2 = sim.particles[collision.p2]
    
    # WIN: Earth eats Sun
    if (p1.hash == "earth" and p2.index == 0) or (p1.index == 0 and p2.hash == "earth"):
        screen.fill((0, 0, 0))
        win_img = pygame.transform.smoothscale(win_img_raw, (800, 600))
        win_rect = win_img.get_rect(center=(WIDTH//2, HEIGHT//2))
        screen.blit(win_img, win_rect)
        pygame.display.flip()
        pygame.time.wait(3000)
        return
    
    # Earth vs planets
    if p1.hash == "earth" or p2.hash == "earth":
        earth = p1 if p1.hash == "earth" else p2
        other = p2 if earth == p1 else p1
        if earth.m >= oth
