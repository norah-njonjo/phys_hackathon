import rebound
import pygame
import numpy as np
import sys

# 1. REBOUND 

sim = rebound.Simulation()
sim.units = ('AU', 'yr', 'Msun')
sim.integrator = "ias15"
# REBOUND collision settings: "direct" checks for collisions at each timestep, "merge" merges colliding particles into one.

sim.collision = "direct"
sim.collision_resolve = "merge"

# Normalize density 
def density(m):
    return m**(1/3)


sim.add(m=1.0)
sim.add(m=3e-6, a=1.0, r=density(3e-6), hash="earth")
 # Earth

sim.move_to_com()

earth = sim.particles["earth"]



dt = 0.0002  # physics timestep (years)
thrust_accel = 15.0     # acceleration magnitude (AU/yr^2)

# 2. pygame 
pygame.init()
WIDTH, HEIGHT = 1000, 1000
screen = pygame.display.set_mode((WIDTH, HEIGHT))
clock = pygame.time.Clock()

SCALE = 300
CENTER = np.array([WIDTH//2, HEIGHT//2])

def custom_merge(sim, collision):
    p1 = sim.particles[collision.p1]
    p2 = sim.particles[collision.p2]

# If Earth is involved
    if p1.hash == "earth" or p2.hash == "earth":
        earth = p1 if p1.hash == "earth" else p2
        other = p2 if earth == p1 else p1
        earth.m += other.m * 10

    # Remove smaller body
        sim.remove(other.index)

    else:
    # Normal merge for others
        sim.merge(collision)
    
sim.collision_resolve = custom_merge

running = True

# 3. Main Loop

while running:

    clock.tick(60)

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    keys = pygame.key.get_pressed()


    #  thrust direction
   
    thrust_vector = np.array([0.0, 0.0])

    if keys[pygame.K_UP]:
        thrust_vector[1] += 1
    if keys[pygame.K_DOWN]:
        thrust_vector[1] -= 1
    if keys[pygame.K_LEFT]:
        thrust_vector[0] -= 1
    if keys[pygame.K_RIGHT]:
        thrust_vector[0] += 1

    if np.linalg.norm(thrust_vector) > 0:
        thrust_vector = thrust_vector / np.linalg.norm(thrust_vector)
        acceleration = thrust_vector * thrust_accel

        # Apply deltav-vee
        earth.vx += acceleration[0] * dt
        earth.vy += acceleration[1] * dt

   # Physics

    sim.integrate(sim.t + dt)

    earth = sim.particles["earth"]


    # Render
 
    screen.fill((0, 0, 0))

    sun = sim.particles[0]
    sun_pos = CENTER + np.array([sun.x, -sun.y]) * SCALE
    pygame.draw.circle(screen, (255, 255, 0), sun_pos.astype(int), 10)

    earth_pos = CENTER + np.array([earth.x, -earth.y]) * SCALE
    pygame.draw.circle(screen, (100, 150, 255), earth_pos.astype(int), 6)

    pygame.display.flip()

pygame.quit()
sys.exit()
